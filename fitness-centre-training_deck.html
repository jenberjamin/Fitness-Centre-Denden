<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Centre | Training Deck</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@300;400;500;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,300,0,0" />

    <style>
        /* --- SYSTEM VARIABLES (TACTICAL HUD) --- */
        :root {
            --font-header: 'Oswald', sans-serif;
            --font-body: 'Red Hat Display', sans-serif;
            
            --color-accent: #00e5ff; /* Cyan */
            --color-accent-dim: rgba(0, 229, 255, 0.15);
            --color-gold: #FFD700;   /* For Folders/Headers */
            
            --color-white: #ffffff;
            --color-white-muted: rgba(255, 255, 255, 0.6);
            
            --glass-bg: rgba(20, 20, 20, 0.6);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            
            --bg-image: url('https://i.imgur.com/CdFreDF.jpeg');
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            height: 100vh; width: 100vw;
            background-image: var(--bg-image); 
            background-size: cover; background-position: center; 
            font-family: var(--font-body); 
            color: var(--color-white); 
            overflow: hidden;
            background-color: #050505;
        }

        /* Heavy vignette overlay */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, rgba(10,12,14,0.7) 0%, rgba(0,0,0,0.95) 100%);
            z-index: 0; pointer-events: none;
        }

        .container {
            position: relative; z-index: 1; height: 100%; display: flex; flex-direction: column; 
            padding: 30px 50px;
            padding-top: 80px; /* Added breathing room for the back button */
        }

        /* --- HEADER --- */
        .top-bar {
            display: flex; align-items: flex-end; justify-content: space-between;
            border-bottom: var(--glass-border); padding-bottom: 20px; margin-bottom: 30px;
        }
        .brand-area { display: flex; flex-direction: column; gap: 5px; }
        
        .logo-icon { width: 30px; height: auto; filter: drop-shadow(0 0 5px var(--color-accent)); margin-bottom: 10px;}
        
        /* THE GLOW UP */
        .page-title { 
            font-family: var(--font-header); font-size: 60px; 
            text-transform: uppercase; letter-spacing: 8px; line-height: 0.8;
            color: transparent; 
            -webkit-text-stroke: 2px rgba(255,255,255,0.9); /* Thicker stroke */
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.2); /* The Electricity */
        }

        .nav-area { display: flex; align-items: center; gap: 30px; }
        
        .search-box {
            background: rgba(0,0,0,0.3); border: var(--glass-border); padding: 10px 15px;
            color: var(--color-white); font-family: var(--font-body); font-size: 12px; 
            width: 250px; letter-spacing: 1px; text-transform: uppercase;
            transition: 0.3s;
        }
        .search-box:focus { border-color: var(--color-accent); outline: none; box-shadow: 0 0 15px var(--color-accent-dim); }

        .nav-link {
            text-decoration: none; color: var(--color-white-muted); font-size: 12px; 
            text-transform: uppercase; letter-spacing: 2px; font-weight: 500; 
            transition: all 0.3s ease; cursor: pointer; position: relative;
        }
        .nav-link:hover, .nav-link.active { color: var(--color-accent); }
        .nav-link.active::after {
            content: ''; position: absolute; bottom: -5px; left: 0; width: 100%; height: 1px; 
            background: var(--color-accent); box-shadow: 0 0 5px var(--color-accent);
        }

        /* --- DEFERRED ALERT SYSTEM (NEW) --- */
        .nav-link.alert-pulse {
            color: #ff9e80; /* Soft Orange/Warning Color */
            text-shadow: 0 0 5px rgba(255, 158, 128, 0.5);
            animation: pulseText 3s infinite alternate;
        }
        
        @keyframes pulseText {
            0% { opacity: 0.7; text-shadow: 0 0 5px rgba(255, 158, 128, 0.2); }
            100% { opacity: 1; text-shadow: 0 0 15px rgba(255, 158, 128, 0.8); }
        }

        /* When we actually click the Deferred tab, make it look active */
        .nav-link.alert-pulse.active {
            color: var(--color-accent);
            text-shadow: 0 0 10px var(--color-accent);
            animation: none; /* Stop pulsing when we are looking at it */
        }

        /* --- CONTENT GRID --- */
        .content-grid { display: flex; gap: 40px; height: 100%; overflow-x: auto; padding-bottom: 20px; padding-right: 40px; }
        .content-grid::-webkit-scrollbar { height: 4px; }
        .content-grid::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .content-grid::-webkit-scrollbar-thumb { background: var(--color-accent); }

        .day-column { min-width: 340px; display: flex; flex-direction: column; gap: 15px; }
        
        .folder-header { 
            display: flex; align-items: center; gap: 10px; font-size: 12px; 
            letter-spacing: 3px; text-transform: uppercase; color: var(--color-gold); 
            font-weight: 700; margin-bottom: 10px; border-bottom: 1px solid rgba(255, 215, 0, 0.2); padding-bottom: 5px;
        }
        
        /* --- CARD DESIGN (HOLO-PAD) --- */
        .workout-card {
            background: var(--glass-bg); 
            backdrop-filter: blur(10px);
            border: var(--glass-border);
            padding: 25px;
            transition: all 0.3s ease; cursor: pointer;
            position: relative; overflow: hidden;
        }
        /* Tech Border Accent */
        .workout-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 3px; height: 100%;
            background: var(--color-accent); opacity: 0.5; transition: 0.3s;
        }

        .workout-card:hover { 
            transform: translateY(-5px); 
            border-color: var(--color-accent); 
            box-shadow: 0 0 30px var(--color-accent-dim);
        }
        .workout-card:hover::before { opacity: 1; box-shadow: 0 0 10px var(--color-accent); }
        
        /* ARCHIVE CARD STYLE */
        .workout-card.archived {
            background: rgba(0,0,0,0.6); border-color: rgba(255,255,255,0.05);
        }
        .workout-card.archived::before { background: #555; }
        .workout-card.archived:hover { border-color: var(--color-white-muted); }

        .card-title { 
            font-family: var(--font-header); font-size: 24px; 
            margin-bottom: 5px; color: var(--color-white); letter-spacing: 1px; 
            text-transform: uppercase;
        }
        .card-sub { font-size: 10px; color: var(--color-accent); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 20px; }
        .card-details { 
            font-size: 12px; color: var(--color-white-muted); line-height: 1.6; 
            display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
        }
        
        /* FAB */
        .fab {
            position: absolute; bottom: 40px; right: 40px; font-size: 48px !important;
            color: var(--color-accent); cursor: pointer; transition: 0.4s;
            filter: drop-shadow(0 0 10px var(--color-accent-dim)); z-index: 99;
            background: rgba(0,0,0,0.8); border-radius: 50%;
        }
        .fab:hover { transform: rotate(90deg) scale(1.1); color: #fff; text-shadow: 0 0 20px var(--color-accent); }

        /* FIXED OVERLAP: Moved top and ensured container has padding */
        .exit-link {
            position: absolute; top: 30px; left: 50px; 
            color: var(--color-white-muted); text-decoration: none; 
            font-size: 10px; letter-spacing: 2px; text-transform: uppercase;
            display: flex; align-items: center; gap: 10px; transition: 0.3s; z-index: 10;
        }
        .exit-link:hover { color: var(--color-accent); gap: 15px; }

        /* --- TEMPLATE MODAL (COMMAND TERMINAL) --- */
        .modal-backdrop {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100; justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }

        .template-modal {
            background: #0a0a0a; width: 700px; 
            border: 1px solid var(--color-accent);
            box-shadow: 0 0 50px rgba(0, 229, 255, 0.1); 
            display: flex; flex-direction: column; max-height: 90vh;
            position: relative;
        }
        /* Corner Accents */
        .template-modal::after {
            content: ''; position: absolute; bottom: 0; right: 0; width: 20px; height: 20px;
            border-bottom: 2px solid var(--color-accent); border-right: 2px solid var(--color-accent);
        }

        .tm-header {
            padding: 25px 40px; border-bottom: 1px solid rgba(255,255,255,0.1); 
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.02);
        }
        .tm-title { 
            color: var(--color-white); font-family: var(--font-header); 
            font-size: 28px; letter-spacing: 2px; text-transform: uppercase;
        }
        
        .header-actions { display: flex; gap: 20px; align-items: center; }
        .header-icon { cursor: pointer; color: #666; font-size: 20px; transition: 0.3s; }
        .header-icon:hover { color: var(--color-accent); }

        .tm-body { padding: 40px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; }

        .input-row { display: flex; align-items: center; gap: 20px; }
        .input-label { 
            width: 140px; font-size: 11px; font-weight: 700; color: var(--color-accent); 
            text-align: right; text-transform: uppercase; letter-spacing: 2px; 
        }
        
        .tm-input {
            flex: 1; background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(255,255,255,0.1); padding: 12px 15px; 
            font-family: var(--font-body); color: #fff; outline: none; 
            transition: 0.3s; font-size: 14px; letter-spacing: 1px;
        }
        .tm-input:focus { border-color: var(--color-accent); background: rgba(0, 229, 255, 0.05); }
        .tm-input:disabled { background: transparent; border-color: transparent; color: #888; cursor: default; }

        /* Exercise Search */
        .search-row { position: relative; margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 30px; }
        .ex-search-input {
            width: 100%; background: #000; border: 1px solid #333; padding: 15px; 
            font-family: var(--font-body); color: #fff; font-size: 14px; letter-spacing: 1px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        .ex-search-input::placeholder { color: #555; text-transform: uppercase; }
        .ex-search-input:focus { border-color: var(--color-accent); outline: none; }

        .search-results {
            position: absolute; top: 85px; left: 0; width: 100%; background: #111; color: #fff;
            max-height: 250px; overflow-y: auto; z-index: 10; display: none;
            border: 1px solid var(--color-accent);
        }
        .result-item { 
            padding: 12px 20px; border-bottom: 1px solid #222; cursor: pointer; font-size: 13px; 
            display: flex; justify-content: space-between; transition: 0.2s;
        }
        .result-item:hover { background: var(--color-accent); color: #000; }

        /* --- ADDED EXERCISE LIST --- */
        .added-list { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        
        .ex-item {
            background: rgba(255,255,255,0.03); 
            border-left: 2px solid var(--color-accent);
            padding: 15px 20px; position: relative;
            transition: 0.3s;
        }
        .ex-item:hover { background: rgba(255,255,255,0.06); }
        .ex-item.ghost-item { border-left-color: var(--color-red); opacity: 0.5; }
        .ex-item.archived-item { border-left-color: #444; background: transparent; }

        .ex-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .ex-title-group { flex: 1; padding-right: 20px; } 
        .ex-name { font-weight: 700; color: var(--color-white); font-size: 14px; letter-spacing: 1px; text-transform: uppercase; display: block; margin-bottom: 5px;}
        .ex-muscle { font-size: 10px; color: #666; text-transform: uppercase; letter-spacing: 1px; display: block;}
        
        .set-row { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
        .set-input { 
            width: 60px; padding: 8px; border: 1px solid #333; text-align: center; 
            background: #000; color: var(--color-accent); font-family: var(--font-body); font-weight: 600; font-size: 12px; 
        }
        .set-input:disabled { background: transparent; border: none; color: #aaa; text-align: left; padding: 0; width: auto; }
        .unit-label { font-size: 9px; color: #555; width: 25px; text-transform: uppercase; }

        .add-set-btn { cursor: pointer; font-size: 18px; color: #444; transition: 0.2s; margin-left: 5px; }
        .add-set-btn:hover { color: var(--color-accent); }
        
        .delete-btn { cursor: pointer; font-size: 16px; color: #444; transition: color 0.2s; display: flex; align-items: center;}
        .delete-btn:hover { color: #ff3d3d; }

        /* --- FOOTER --- */
        .tm-footer {
            padding: 20px 40px; background: rgba(255,255,255,0.02); display: flex; justify-content: space-between; align-items: center; 
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .tm-footer-right { display: flex; align-items: center; gap: 20px; margin-left: auto; }
        .tm-btn { border: none; background: none; font-weight: 700; font-size: 12px; cursor: pointer; letter-spacing: 2px; transition: all 0.3s; text-transform: uppercase; }
        
        .btn-add { 
            background-color: var(--color-accent); color: #000; 
            padding: 15px 40px; 
            box-shadow: 0 0 20px var(--color-accent-dim);
        }
        .btn-add:hover { background-color: #fff; box-shadow: 0 0 30px var(--color-accent-dim); }
        
        .btn-cancel { color: #666; border: 1px solid transparent; padding: 10px 20px; }
        .btn-cancel:hover { border-color: #ff3d3d; color: #ff3d3d; }
        
        .btn-delete-icon { 
            color: #ff3d3d; font-size: 20px !important; cursor: pointer; transition: 0.3s; 
            background: rgba(255, 61, 61, 0.1); padding: 10px; border-radius: 50%;
        }
        .btn-delete-icon:hover { background: rgba(255, 61, 61, 0.3); box-shadow: 0 0 15px rgba(255, 61, 61, 0.2); }

	.folder-group { flex: 1; display: flex; gap: 10px; align-items: center; }
        
        .btn-delete-folder {
            background: rgba(255, 61, 61, 0.1); 
            border: 1px solid rgba(255, 61, 61, 0.3);
            color: #ff3d3d;
            width: 40px; height: 42px; /* Matches input height */
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s;
        }
        .btn-delete-folder:hover {
            background: #ff3d3d; color: #000; box-shadow: 0 0 15px rgba(255, 61, 61, 0.4);
        }


    </style>
</head>
<body>

    <div class="overlay"></div>

    <div class="container">
        <a href="FITNESS-CENTRE.html" class="exit-link"><span class="material-symbols-outlined" style="font-size:14px">arrow_back</span> BACK TO FITNESSHUB</a>

        <div class="top-bar">
            <div class="brand-area">
                <h1 class="page-title">Training Deck</h1>
            </div>

            <div class="nav-area">
                <input type="text" class="search-box" placeholder="SEARCH DATABASE..." onkeyup="applySearchFilter(this.value)">
                <a href="fitness-centre-exercise_index.html" class="nav-link">Exercise Index</a>
                <span class="nav-link" id="navActive" onclick="switchView('active')">Active Plan</span>
                <span class="nav-link" id="navDeferred" onclick="switchView('deferred')">Deferred</span>
                <span class="nav-link" id="navArchive" onclick="switchView('archive')">Log Archive</span>
            </div>
        </div>

        <div class="content-grid" id="folderGrid"></div>

        <span class="material-symbols-outlined fab" id="fabBtn" onclick="openTemplateModal(null)">add</span>
    </div>

    <div class="modal-backdrop" id="templateModal">
        <div class="template-modal">
            <div class="tm-header">
                <span class="tm-title" id="modalTitle">New Template</span>
                <div class="header-actions">
                    <span class="material-symbols-outlined header-icon" id="btnDuplicate" title="Duplicate" style="display:none;" onclick="duplicateTemplate()">content_copy</span>
                    <span style="cursor:pointer; color:#666; font-size: 24px; transition:0.3s;" onclick="closeTemplateModal()" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#666'">close</span>
                </div>
            </div>
            
            <div class="tm-body">
                <div class="input-row">
                    <label class="input-label">Name:</label>
                    <input type="text" id="tmName" class="tm-input" placeholder="WORKOUT NAME..." oninput="markDirty()">
                </div>

                <div class="input-row">
                    <label class="input-label">Folder:</label>
                    <div class="folder-group">
                        <input type="text" id="tmFolder" class="tm-input" list="folderOptions" placeholder="SELECT OR CREATE..." oninput="markDirty()">
                        <div class="material-symbols-outlined btn-delete-folder" onclick="deleteFolderSafe()" title="Delete Folder & Move Items to Unsorted">remove</div>
                    </div>
                    <datalist id="folderOptions"></datalist>
                </div>

                <div class="input-row">
                    <label class="input-label">Scheduled For:</label>
                    <input type="date" id="tmDate" class="tm-input" oninput="markDirty()">
                </div>

                <div class="search-row" id="searchRow">
                    <span style="font-size:10px; color:#666; margin-bottom:10px; display:block; font-weight:700; text-transform:uppercase; letter-spacing:1px; text-align:right">Total Exercises: <span id="exCount" style="color:var(--color-accent); font-size:14px;">0</span></span>
                    <input type="text" class="ex-search-input" placeholder="SEARCH EXERCISE DATABASE..." onkeyup="searchExercises(this.value)">
                    <div class="search-results" id="searchResults"></div>
                </div>

                <div class="added-list" id="addedList"></div>
            </div>

            <div class="tm-footer">
                <span class="material-symbols-outlined btn-delete-icon" id="btnDelete" style="display:none;" onclick="deleteTemplate()" title="Delete Template">delete_forever</span>
                
                <div class="tm-footer-right">
                    <button class="tm-btn btn-cancel" onclick="closeTemplateModal()">CANCEL</button>
                    <button class="tm-btn btn-add" id="btnSave" onclick="saveTemplate()">SAVE</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        let exerciseDB = JSON.parse(localStorage.getItem('lh_exercises')) || [];
        let templatesDB = JSON.parse(localStorage.getItem('lh_templates')) || [];
        let currentExercises = []; 
        let editTemplateId = null; 
        let isDirty = false; 
        let currentView = 'active'; // 'active', 'deferred', or 'archive'
        let searchQuery = "";

        window.onload = function() { 
            cleanupGhosts();
            switchView('active'); // Default to Active View
        }

        function cleanupGhosts() {
            const initial = templatesDB.length;
            templatesDB = templatesDB.filter(t => t.exercises && Array.isArray(t.exercises));
            if(templatesDB.length !== initial) localStorage.setItem('lh_templates', JSON.stringify(templatesDB));
        }

        function markDirty() { isDirty = true; }

        function applySearchFilter(query) {
            searchQuery = query.toLowerCase();
            renderFolders();
        }

        // --- UPDATED VIEW SWITCHER (NOW HANDLES DEFERRED) ---
        function switchView(view) {
            currentView = view;
            const titleEl = document.querySelector('.page-title');
            
            // Reset UI
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            // Ensure FAB is visible for Active/Deferred, hidden for Archive
            document.getElementById('fabBtn').style.display = (view === 'archive') ? 'none' : 'block';

            if(view === 'active') {
                document.getElementById('navActive').classList.add('active');
                titleEl.innerText = "ACTIVE MISSION DECK";
                titleEl.style.webkitTextStroke = "2px rgba(255,255,255,0.9)"; 
                titleEl.style.textShadow = "0 0 20px rgba(255, 255, 255, 0.4)"; 
                
            } else if (view === 'deferred') {
                document.getElementById('navDeferred').classList.add('active');
                titleEl.innerText = "DEFERRED TASKS";
                // Warning/Orange Hue for visual distinction
                titleEl.style.webkitTextStroke = "2px rgba(255, 158, 128, 0.9)"; 
                titleEl.style.textShadow = "0 0 20px rgba(255, 158, 128, 0.4)"; 

            } else {
                document.getElementById('navArchive').classList.add('active');
                titleEl.innerText = "LOG ARCHIVE";
                titleEl.style.webkitTextStroke = "2px rgba(255, 255, 255, 0.5)"; 
                titleEl.style.textShadow = "none"; 
            }
            
            renderFolders();
        }

        // --- UPDATED RENDER LOGIC (WITH DATE FILTER & PULSE) ---
        // --- SAM BENNETT PATCH: GRACE-AWARE SMART FOLDERS ---
        function renderFolders() {
            const grid = document.getElementById('folderGrid');
            grid.innerHTML = '';
            const grouped = {};
            
            // 1. GET TODAY'S DATE
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const todayStr = `${year}-${month}-${day}`;

            // 2. CHECK FOR GRACE (Did we use it today?)
            let isGraceActive = false;
            const rawUser = localStorage.getItem('LifeHub_RPG_User');
            if (rawUser) {
                const user = JSON.parse(rawUser);
                if (user.systemLogs) {
                    // Look for a log with type 'grace' that matches today's date
                    isGraceActive = user.systemLogs.some(log => {
                        if (log.type !== 'grace') return false;
                        // Log dates are ISO strings (2025-11-26T...), we need to slice the date part
                        const logDate = log.date.split('T')[0];
                        return logDate === todayStr;
                    });
                }
            }

            // 3. FILTER LOGIC (Now with Grace Logic)
            const relevantTemplates = templatesDB.filter(t => {
                const matchesSearch = t.name.toLowerCase().includes(searchQuery);
                if (!matchesSearch) return false;

                if (currentView === 'archive') {
                    // Archive: Always completed
                    return t.isCompleted;
                } 
                else if (currentView === 'deferred') {
                    // Deferred: Incomplete AND (Past Date OR (Today + Grace))
                    const isPast = t.date < todayStr;
                    const isTodayButSkipped = (t.date === todayStr && isGraceActive);
                    return !t.isCompleted && (isPast || isTodayButSkipped);
                } 
                else {
                    // Active: Incomplete AND (Future Date OR (Today + No Grace))
                    const isFuture = t.date > todayStr;
                    const isTodayAndActive = (t.date === todayStr && !isGraceActive);
                    return !t.isCompleted && (isFuture || isTodayAndActive);
                }
            });
            
            // 4. CHECK DEFERRED PULSE (Updated for Grace)
            // Pulse if we have past items OR if we graced today's items
            const hasDeferredItems = templatesDB.some(t => {
                if (t.isCompleted) return false;
                if (t.date < todayStr) return true;
                if (t.date === todayStr && isGraceActive) return true;
                return false;
            });

            const defLink = document.getElementById('navDeferred');
            if(hasDeferredItems) defLink.classList.add('alert-pulse');
            else defLink.classList.remove('alert-pulse');

            // 5. GROUPING
            relevantTemplates.forEach(t => {
                // If Active View + Today + No Grace -> Hijack to TODAY
                // (Note: The filter above already removes Today items if Grace IS active, so this is safe)
                if (currentView === 'active' && t.date === todayStr) {
                    if(!grouped['TODAY']) grouped['TODAY'] = [];
                    grouped['TODAY'].push(t);
                } else {
                    if(!grouped[t.folder]) grouped[t.folder] = [];
                    grouped[t.folder].push(t);
                }
            });

            // 6. EMPTY STATE
            if(Object.keys(grouped).length === 0) {
                let msg = "NO ACTIVE PLANS";
                let sub = "Create a new workout plan.";
                if(currentView === 'archive') { msg = "ARCHIVE EMPTY"; sub = "Complete a workout to log it."; }
                if(currentView === 'deferred') { 
                    if(isGraceActive) { msg = "GRACE PROTOCOL ACTIVE"; sub = "Rest well. Tasks deferred to tomorrow."; }
                    else { msg = "NO DEFERRED TASKS"; sub = "You are all caught up."; }
                }
                
                grid.innerHTML = `<div style="color:#444; margin:auto; text-align:center; font-family:var(--font-header); letter-spacing:2px;">${msg}<br><span style="font-family:var(--font-body); font-size:12px; color:#333;">${sub}</span></div>`; 
                return;
            }

            // 7. SORTING
            let folderKeys = Object.keys(grouped).sort();
            if (grouped['TODAY']) {
                folderKeys = folderKeys.filter(k => k !== 'TODAY');
                folderKeys.unshift('TODAY');
            }

            // 8. RENDER COLUMNS
            folderKeys.forEach(folder => {
                const col = document.createElement('div');
                col.className = 'day-column';
                
                let icon = "folder_open";
                let color = "var(--color-gold)";
                let titleClass = "";
                
                if (folder === 'TODAY') {
                    icon = "star"; 
                    color = "var(--color-accent)"; 
                    titleClass = "text-shadow: 0 0 10px var(--color-accent-dim);"; 
                }

                let cardsHTML = grouped[folder].map(t => {
                    let muscleSet = new Set();
                    if(t.exercises) {
                        t.exercises.forEach(tempEx => {
                            const fullEx = exerciseDB.find(e => e.id == tempEx.dbId);
                            if(fullEx && fullEx.target) fullEx.target.forEach(m => muscleSet.add(m));
                        });
                    }
                    let summary = "General Conditioning";
                    if(muscleSet.size > 0) {
                        const ary = Array.from(muscleSet);
                        summary = ary.length > 3 ? ary.slice(0,3).join(', ') + "..." : ary.join(', ');
                    }
                    
                    const displayDate = t.date ? new Date(t.date).toLocaleDateString(undefined, {month:'short', day:'numeric'}).toUpperCase() : 'NO DATE';
                    const count = t.exercises ? t.exercises.length : 0;
                    const cardClass = t.isCompleted ? 'workout-card archived' : 'workout-card';

                    return `
                    <div class="${cardClass}" onclick="openTemplateModal(${t.id})">
                        <div class="card-title">${t.name}</div>
                        <div class="card-sub">${displayDate} • ${count} EXERCISES</div>
                        <div class="card-details">${summary}</div>
                    </div>`;
                }).join('');

                col.innerHTML = `
                    <div class="folder-header" style="color:${color}; ${titleClass}">
                        <span class="material-symbols-outlined" style="font-size:14px; color:${color};">${icon}</span> 
                        ${folder}
                    </div>
                    ${cardsHTML}`;
                
                grid.appendChild(col);
            });
            updateFolderDatalist();
        }

        function updateFolderDatalist() {
            const folders = [...new Set(templatesDB.map(t => t.folder))];
            document.getElementById('folderOptions').innerHTML = folders.map(f => `<option value="${f}">`).join('');
        }

        // --- OPEN MODAL ---
        function openTemplateModal(id = null) {
            currentExercises = [];
            document.getElementById('addedList').innerHTML = '';
            document.getElementById('searchResults').style.display = 'none';
            document.querySelector('.ex-search-input').value = '';
            isDirty = false; 
            
            const setInputsDisabled = (disabled) => {
                document.querySelectorAll('.tm-input').forEach(i => i.disabled = disabled);
                document.getElementById('searchRow').style.display = disabled ? 'none' : 'block';
                document.getElementById('btnSave').style.display = disabled ? 'none' : 'block';
                document.getElementById('btnDelete').style.display = disabled ? 'none' : 'block';
                if(disabled) document.getElementById('modalTitle').innerText = "LOG RECORD";
            };

            if(id) {
                editTemplateId = id;
                const t = templatesDB.find(temp => temp.id === id);
                
                document.getElementById('tmName').value = t.name;
                document.getElementById('tmFolder').value = t.folder;
                document.getElementById('tmDate').value = t.date;
                
                if (t.isCompleted) {
                    setInputsDisabled(true);
                    document.getElementById('btnDuplicate').style.display = 'block'; 
                } else {
                    setInputsDisabled(false);
                    document.getElementById('modalTitle').innerText = "EDIT TEMPLATE";
                    document.getElementById('btnSave').innerText = "SAVE";
                    document.getElementById('btnDelete').style.display = 'block'; 
                    document.getElementById('btnDuplicate').style.display = 'block'; 
                }

                if(t.exercises && t.exercises.length > 0) {
                    t.exercises.forEach(ex => addExerciseToUI(ex.dbId, false, ex.sets, t.isCompleted)); 
                }

            } else {
                editTemplateId = null;
                setInputsDisabled(false);
                document.getElementById('modalTitle').innerText = "NEW TEMPLATE";
                document.getElementById('tmName').value = '';
                document.getElementById('tmFolder').value = '';
                document.getElementById('tmDate').value = '';
                document.getElementById('btnSave').innerText = "SAVE";
                document.getElementById('btnDelete').style.display = 'none';
                document.getElementById('btnDuplicate').style.display = 'none';
            }
            updateCount();
            document.getElementById('templateModal').style.display = 'flex';
        }
        
        function duplicateTemplate() {
            if(!confirm("Clone this template? Date will be reset.")) return;
            document.querySelectorAll('.tm-input').forEach(i => i.disabled = false);
            document.getElementById('searchRow').style.display = 'block';
            document.getElementById('btnSave').style.display = 'block';

            editTemplateId = null;
            document.getElementById('modalTitle').innerText = "CLONED TEMPLATE (UNSAVED)";
            document.getElementById('tmDate').value = ""; 
            document.getElementById('btnSave').innerText = "SAVE";
            document.getElementById('btnDelete').style.display = 'none';
            document.getElementById('btnDuplicate').style.display = 'none';
            
            isDirty = true; 
            const currentExCopy = [...currentExercises]; 
        }

        function closeTemplateModal() { 
            if(isDirty) {
                if(confirm("Abort changes? Data will be lost.")) document.getElementById('templateModal').style.display = 'none'; 
            } else {
                document.getElementById('templateModal').style.display = 'none';
            }
        }

        // --- EXERCISE LOGIC ---
        function searchExercises(query) {
            const resultsBox = document.getElementById('searchResults');
            if(query.length < 1) { resultsBox.style.display = 'none'; return; }
            const matches = exerciseDB.filter(ex => ex.name.toLowerCase().includes(query.toLowerCase()));
            resultsBox.innerHTML = matches.map(ex => `<div class="result-item" onclick="addExerciseToUI(${ex.id}, true)"><span>${ex.name} <span style="color:#666;">(${ex.equip})</span></span></div>`).join('');
            resultsBox.style.display = matches.length > 0 ? 'block' : 'none';
        }

        function addExerciseToUI(id, triggerDirty = true, loadedSets = null, isReadOnly = false) {
            let ex = exerciseDB.find(e => e.id == id);
            let isGhost = false;
            if (!ex) { ex = { id: id, name: "Unknown/Deleted", target: ["Unknown"], type: "Reps", equip: "Unknown" }; isGhost = true; }

            const tempId = Date.now() + Math.random(); 
            currentExercises.push({ dbId: ex.id, name: ex.name, tempId: tempId });
            if(triggerDirty) markDirty();

            const container = document.getElementById('addedList');
            const item = document.createElement('div');
            // Updated Classes for Dark UI
            item.className = `ex-item ${isGhost ? 'ghost-item' : ''} ${isReadOnly ? 'archived-item' : ''}`;
            item.id = `ex-${tempId}`;
            
            const delBtn = isReadOnly ? '' : `<span class="material-symbols-outlined delete-btn" onclick="removeEx('${tempId}')">close</span>`;
            
            item.innerHTML = `
                <div class="ex-header-row">
                    <div class="ex-title-group"><span class="ex-name">${ex.name}</span><span class="ex-muscle">${isGhost?'Deleted':ex.target.join(', ')+' • '+ex.equip}</span></div>
                    ${delBtn}
                </div>
                <div class="sets-container"></div>
            `;
            container.appendChild(item);

            const setsContainer = item.querySelector('.sets-container');
            if(loadedSets && loadedSets.length > 0) {
                loadedSets.forEach(vals => addSetRowToContainer(setsContainer, ex.type, vals, isReadOnly));
            } else {
                addSetRowToContainer(setsContainer, ex.type, [], isReadOnly);
            }
            document.getElementById('searchResults').style.display = 'none';
            document.querySelector('.ex-search-input').value = ''; 
            updateCount();
        }

        function getSetInputHTML(type, values = [], isReadOnly) {
            const dirtyAttr = 'oninput="markDirty()"';
            const dis = isReadOnly ? 'disabled' : '';
            const v1 = values[0] || ''; const v2 = values[1] || '';
            
            // Note: In Dark UI, we keep inputs minimal
            if (type === "Weight & Reps") return `<input type="text" class="set-input" placeholder="KG" value="${v1}" ${dirtyAttr} ${dis}><span class="unit-label">KG</span><input type="text" class="set-input" placeholder="REPS" value="${v2}" ${dirtyAttr} ${dis}><span class="unit-label">REPS</span>`;
            if (type === "Reps") return `<input type="text" class="set-input" placeholder="REPS" value="${v1}" ${dirtyAttr} ${dis}><span class="unit-label">REPS</span>`;
            if (type === "Time") return `<input type="text" class="set-input" placeholder="SEC" value="${v1}" ${dirtyAttr} ${dis}><span class="unit-label">SEC</span><input type="text" class="set-input" placeholder="MIN" value="${v2}" ${dirtyAttr} ${dis}><span class="unit-label">MIN</span>`;
            if (type === "Distance") return `<input type="text" class="set-input" placeholder="M" value="${v1}" ${dirtyAttr} ${dis}><span class="unit-label">M</span>`;
            
            return `<input type="text" class="set-input" placeholder="REPS" value="${v1}" ${dirtyAttr} ${dis}><span class="unit-label">REPS</span>`;
        }

        function addSetRowToContainer(container, type, values = [], isReadOnly = false) {
            const newRow = document.createElement('div');
            newRow.className = 'set-row';
            const controls = isReadOnly ? '' : ` <span class="material-symbols-outlined add-set-btn" title="Add Set" onclick="addSetRowToContainer(this.parentElement.parentElement, '${type}')">add_circle</span> <span class="material-symbols-outlined delete-btn" style="font-size:16px; margin-left:10px; color:#444;" title="Remove Set" onclick="this.parentElement.remove(); markDirty();">remove</span>`;
            
            newRow.innerHTML = `${getSetInputHTML(type, values, isReadOnly)}${controls}`;
            container.appendChild(newRow);
        }

        function removeEx(tempId) {
            markDirty();
            currentExercises = currentExercises.filter(e => e.tempId != tempId);
            document.getElementById(`ex-${tempId}`).remove();
            updateCount();
        }

        function updateCount() { document.getElementById('exCount').innerText = currentExercises.length; }

        // --- SAVE / DELETE ---
        function saveTemplate() {
            const name = document.getElementById('tmName').value;
            const folder = document.getElementById('tmFolder').value;
            const date = document.getElementById('tmDate').value;

            if(!name || !folder || !date) return alert("System Protocol: Name, Folder, and Date required."); 
            if(currentExercises.length === 0) return alert("System Protocol: Template requires at least one exercise.");

            const exercisesWithData = currentExercises.map(e => {
                const domItem = document.getElementById(`ex-${e.tempId}`);
                if (!domItem) return null;
                const setRows = domItem.querySelectorAll('.set-row');
                const setsData = Array.from(setRows).map(row => {
                    const inputs = row.querySelectorAll('.set-input');
                    return Array.from(inputs).map(input => input.value);
                });
                return { dbId: e.dbId, name: e.name, sets: setsData };
            }).filter(e => e !== null);

            const templateObj = {
                id: editTemplateId ? editTemplateId : Date.now(),
                name: name, folder: folder, date: date,
                exercises: exercisesWithData,
                // Maintain completion status if editing existing
                isCompleted: editTemplateId ? (templatesDB.find(t=>t.id===editTemplateId)?.isCompleted || false) : false
            };

            if(editTemplateId) {
                const idx = templatesDB.findIndex(t => t.id === editTemplateId);
                if(idx !== -1) templatesDB[idx] = templateObj;
            } else {
                templatesDB.push(templateObj);
            }

            localStorage.setItem('lh_templates', JSON.stringify(templatesDB));
            isDirty = false; 
            renderFolders(); updateFolderDatalist();
            document.getElementById('templateModal').style.display = 'none';
        }

        function deleteTemplate() {
            if(confirm("Purge this record from database?")) {
                templatesDB = templatesDB.filter(t => t.id !== editTemplateId);
                localStorage.setItem('lh_templates', JSON.stringify(templatesDB));
                renderFolders();
                isDirty = false; 
                document.getElementById('templateModal').style.display = 'none';
            }
        }

// --- PATCH: FAIL-SAFE FOLDER DELETION ---
        function deleteFolderSafe() {
            const folderInput = document.getElementById('tmFolder');
            const targetFolder = folderInput.value.trim();

            // 1. Validation
            if (!targetFolder) return alert("System: No folder selected.");
            if (targetFolder.toLowerCase() === "unsorted") return alert("System Alert: 'Unsorted' is a protected root directory. Cannot delete.");

            // 2. Check if folder actually exists in DB
            const itemsInFolder = templatesDB.filter(t => t.folder === targetFolder);
            if (itemsInFolder.length === 0) {
                folderInput.value = ""; // Just clear the text if it's not a real folder yet
                return; 
            }

            // 3. The Confirmation
            const count = itemsInFolder.length;
            const confirmMsg = `WARNING: You are about to dissolve the folder "${targetFolder}".\n\n${count} template(s) will be moved to "Unsorted".\n\nProceed?`;

            if (confirm(confirmMsg)) {
                // 4. execute Migration
                templatesDB.forEach(t => {
                    if (t.folder === targetFolder) {
                        t.folder = "Unsorted";
                    }
                });

                // 5. Save & Refresh
                localStorage.setItem('lh_templates', JSON.stringify(templatesDB));
                
                // Update UI immediately
                renderFolders();
                updateFolderDatalist();
                
                // Set the current input to the new home
                folderInput.value = "Unsorted";
                markDirty(); // Mark form as dirty so we know to save the specific template we are editing
                
                alert(`Migration Complete. ${count} items moved to Unsorted.`);
            }
        }


    </script>
</body>
</html>