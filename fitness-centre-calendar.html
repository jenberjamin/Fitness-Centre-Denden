<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Centre | Calendar View</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@300;400;500;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,300,0,0" />

    <style>
        /* --- SYSTEM VISUALS (DARK PRESTIGE) --- */
        :root {
            --font-header: 'Oswald', sans-serif;
            --font-body: 'Red Hat Display', sans-serif;
            
            --color-bg: #050505;
            --color-accent: #00e5ff; /* Planned */
            --color-green: #00ff9d;  /* Done */
            --color-gold: #FFD700;   /* Level Up */
            --color-red: #ff3d3d;    /* Missed/Streak Break */
            --color-grace: #aa139b;  /* Grace Protocol (Neon Pink) */
            --color-luteal: #9b59b6; /* Luteal (Purple) */
            
            --color-white: #ffffff;
            --color-white-muted: rgba(255, 255, 255, 0.5);
            
            --glass-bg: rgba(20, 20, 20, 0.6);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            
            --bg-image: url('https://i.imgur.com/xkHee4y.jpeg');
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            height: 100vh; width: 100vw;
            background-image: var(--bg-image); 
            background-size: cover; background-position: center;
            font-family: var(--font-body); color: var(--color-white); 
            overflow: hidden; background-color: var(--color-bg);
        }

        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.75); z-index: 0; pointer-events: none;
        }

        .container {
            position: relative; z-index: 1; height: 100%; display: flex; flex-direction: column;
            padding: 30px 50px;
        }

        /* --- HEADER --- */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .back-btn { 
            cursor: pointer; color: var(--color-white-muted); transition: 0.3s; 
            font-size: 24px !important; display: flex; align-items: center; gap: 10px;
            text-transform: uppercase; font-size: 12px; letter-spacing: 2px; text-decoration: none;
        }
        .back-btn:hover { color: var(--color-accent); }

        .calendar-controls { display: flex; align-items: center; gap: 30px; }
        
        .month-title { 
            font-family: var(--font-header); font-size: 36px; 
            text-transform: uppercase; letter-spacing: 4px; color: #fff; 
            min-width: 300px; text-align: center;
        }
        
        .nav-btn { 
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2);
            color: #fff; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s;
        }
        .nav-btn:hover { background: var(--color-accent); color: #000; border-color: var(--color-accent); }

        /* --- CALENDAR GRID --- */
        .calendar-wrapper { flex: 1; display: flex; flex-direction: column; }
        
        .weekdays { 
            display: grid; grid-template-columns: repeat(7, 1fr); 
            margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;
        }
        .day-name { 
            text-align: center; color: var(--color-white-muted); 
            font-size: 12px; letter-spacing: 2px; text-transform: uppercase; 
        }

        .days-grid { 
            display: grid; grid-template-columns: repeat(7, 1fr); 
            grid-template-rows: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px; flex: 1;
        }

        /* --- DAY TILE (THE GLASS BOX) --- */
        .day-cell {
            background: rgba(255,255,255,0.02); border: var(--glass-border);
            padding: 10px; position: relative; transition: 0.3s;
            display: flex; flex-direction: column; justify-content: space-between;
            min-height: 100px;
        }
        .day-cell:hover { background: rgba(255,255,255,0.05); }
        
        .date-num { font-family: var(--font-header); font-size: 18px; color: rgba(255,255,255,0.3); }
        .today .date-num { color: var(--color-accent); text-shadow: 0 0 10px var(--color-accent); }

        /* STATUS BORDERS */
        .status-done { border: 1px solid var(--color-green); box-shadow: inset 0 0 20px rgba(0, 255, 157, 0.1); }
        .status-planned { border: 1px solid var(--color-accent); }
        .status-grace { border: 1px solid var(--color-grace); background: rgba(170, 19, 155, 0.1); }
        .status-missed { border: 1px solid var(--color-red); opacity: 0.8; background: rgba(255, 61, 61, 0.05); }

        /* CONTENT INSIDE TILE */
        .cell-content { display: flex; flex-direction: column; gap: 4px; }
        .workout-pill { 
            font-size: 9px; background: rgba(255,255,255,0.1); padding: 4px 6px; 
            text-transform: uppercase; letter-spacing: 1px; color: #fff;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .status-done .workout-pill { color: var(--color-green); background: rgba(0, 255, 157, 0.1); }
        .status-missed .workout-pill { text-decoration: line-through; color: var(--color-red); }
        .status-grace .workout-pill { color: var(--color-grace); }

        /* --- BADGES (ELEVATED AESTHETICS) --- */
        .badge-container { 
            display: flex; gap: 8px; justify-content: flex-end; flex-wrap: wrap;
            margin-top: auto; /* Push to bottom */
            padding-top: 5px;
        }

        .badge { 
            font-size: 18px !important; /* Increased from 14px */
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Bouncy hover */
            cursor: help;
        }
        .badge:hover { transform: scale(1.3); }
        
        /* 1. THE PHOTO (Tech Cyan) */
        .badge-photo { 
            color: var(--color-accent); 
            filter: drop-shadow(0 0 5px rgba(0, 229, 255, 0.4));
        }
        
        /* 2. STATS (Clean White) */
        .badge-stats { 
            color: #fff; opacity: 0.7;
        }

        /* 3. LUTEAL (Deep Purple Glow) */
        .badge-luteal { 
            color: var(--color-luteal); 
            text-shadow: 0 0 8px rgba(155, 89, 182, 0.8);
        }

        /* 4. STREAK BREAK (Alarm Red) */
        .badge-break { 
            color: var(--color-red); 
            filter: drop-shadow(0 0 4px rgba(255, 61, 61, 0.6));
        }

        /* 5. THE TROPHY (The Main Event) */
        .badge-levelup { 
            font-size: 24px !important; /* Significantly larger */
            color: var(--color-gold); 
            /* Multi-layer glow for metallic effect */
            text-shadow: 
                0 0 5px rgba(255, 215, 0, 0.8),
                0 0 15px rgba(255, 215, 0, 0.4),
                0 0 25px rgba(255, 215, 0, 0.2);
            animation: trophyFloat 3s ease-in-out infinite;
        }

        @keyframes trophyFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px) scale(1.1); filter: brightness(1.2); }
        }

        /* --- LEGEND --- */
        .legend-bar { 
            display: flex; gap: 20px; margin-top: 20px; justify-content: center;
            padding-top: 15px; border-top: var(--glass-border);
        }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: #aaa; }
        .dot { width: 8px; height: 8px; border-radius: 50%; }

    </style>
</head>
<body>

    <div class="overlay"></div>

    <div class="container">
        <div class="top-bar">
            <a href="FITNESS-CENTRE.html" class="back-btn">
                <span class="material-symbols-outlined">arrow_back</span> BACK TO LOBBY
            </a>
            
            <div class="calendar-controls">
                <div class="nav-btn" onclick="changeMonth(-1)"><span class="material-symbols-outlined">chevron_left</span></div>
                <div class="month-title" id="monthDisplay">JANUARY 2025</div>
                <div class="nav-btn" onclick="changeMonth(1)"><span class="material-symbols-outlined">chevron_right</span></div>
            </div>
            
            <div style="width: 100px;"></div> 
        </div>

        <div class="calendar-wrapper">
            <div class="weekdays">
                <div class="day-name">Sun</div>
                <div class="day-name">Mon</div>
                <div class="day-name">Tue</div>
                <div class="day-name">Wed</div>
                <div class="day-name">Thu</div>
                <div class="day-name">Fri</div>
                <div class="day-name">Sat</div>
            </div>
            <div class="days-grid" id="calendarGrid">
                </div>
        </div>

        <div class="legend-bar">
            <div class="legend-item"><div class="dot" style="background:var(--color-green)"></div>Complete</div>
            <div class="legend-item"><div class="dot" style="background:var(--color-accent)"></div>Planned</div>
            <div class="legend-item"><div class="dot" style="background:var(--color-grace)"></div>Grace</div>
            <div class="legend-item"><div class="dot" style="background:var(--color-red)"></div>Missed</div>
            <div class="legend-item"><span class="material-symbols-outlined" style="font-size:12px; color:var(--color-luteal)">female</span> Luteal</div>
        </div>
    </div>

    <script src="js/core.js"></script>

    <script>
        let currentDt = new Date();

        window.onload = function() {
            if (typeof UserProfile === 'undefined') { console.warn("Core.js missing"); }
            renderCalendar();
        };

        function changeMonth(dir) {
            currentDt.setMonth(currentDt.getMonth() + dir);
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            const year = currentDt.getFullYear();
            const month = currentDt.getMonth();
            
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('monthDisplay').innerText = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // LOAD DATABASES
            const templates = JSON.parse(localStorage.getItem('lh_templates')) || [];
            const gallery = JSON.parse(localStorage.getItem('LifeHub_Gallery')) || [];
            const measurements = JSON.parse(localStorage.getItem('LifeHub_Measurements')) || [];
            const logs = (typeof UserProfile !== 'undefined' && UserProfile.systemLogs) ? UserProfile.systemLogs : [];

            // 1. Padding (Ghost Cells)
            for (let i = 0; i < firstDay; i++) {
                const pad = document.createElement('div');
                pad.className = 'day-cell';
                pad.style.opacity = '0.1';
                grid.appendChild(pad);
            }

            // 2. Actual Days
            for (let i = 1; i <= daysInMonth; i++) {
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                
                // NEW CODE (The Local Patriot)
const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;

// Check strictly against your computer's local clock
const now = new Date();
const isToday = (now.getFullYear() === year && now.getMonth() === month && now.getDate() === i);

if(isToday) cell.classList.add('today');

                cell.innerHTML = `<div class="date-num">${i}</div>`;

                // --- LOGIC LAYER ---
                
                // A. WORKOUT STATUS
                const workout = templates.find(t => t.date === dateStr);
                let statusClass = '';
                
                if (workout) {
                    if (workout.isCompleted) {
                        statusClass = 'status-done';
                        cell.innerHTML += `<div class="cell-content"><div class="workout-pill">${workout.name}</div></div>`;
                    } else {
                        const checkDate = new Date(dateStr);
                        const todayDate = new Date();
                        todayDate.setHours(0,0,0,0);
                        
                        if (checkDate < todayDate) {
                            statusClass = 'status-missed';
                            cell.innerHTML += `<div class="cell-content"><div class="workout-pill">MISSED</div></div>`;
                        } else {
                            statusClass = 'status-planned';
                            cell.innerHTML += `<div class="cell-content"><div class="workout-pill">${workout.name}</div></div>`;
                        }
                    }
                }

                // B. GRACE CHECK (Overrides Missed/Planned)
                const graceLog = logs.find(l => l.date.startsWith(dateStr) && l.type === 'grace');
                if (graceLog) {
                    statusClass = 'status-grace';
                    
                    // Remove previous pill if any (e.g. if a workout was planned there)
                    const existingPill = cell.querySelector('.cell-content');
                    if(existingPill) existingPill.remove();

                    // --- NEW LOGIC: EXTRACT THE REASON ---
                    // The log text is saved as "[GRACE PROTOCOL] Reason"
                    // We want to strip the tag and just show the "Reason"
                    let reason = "GRACE"; // Fallback
                    if (graceLog.text && graceLog.text.includes('[GRACE PROTOCOL]')) {
                        reason = graceLog.text.replace('[GRACE PROTOCOL]', '').trim().toUpperCase();
                    }

                    // If reason is empty or just whitespace, revert to GRACE
                    if (reason === "") reason = "GRACE";

                    cell.innerHTML += `<div class="cell-content"><div class="workout-pill">${reason}</div></div>`;
                }

                // C. ICON BADGES
                let badgesHTML = `<div class="badge-container">`;
                
                // Gallery
                if (gallery.some(p => p.dateCaptured === dateStr)) {
                    badgesHTML += `<span class="material-symbols-outlined badge badge-photo">photo_camera</span>`;
                }
                
                // Stats
                if (measurements.some(m => m.date.startsWith(dateStr))) {
                    badgesHTML += `<span class="material-symbols-outlined badge badge-stats">straighten</span>`;
                }

                // Level Up
                if (logs.some(l => l.date.startsWith(dateStr) && l.type === 'levelup')) {
                    badgesHTML += `<span class="material-symbols-outlined badge badge-levelup">emoji_events</span>`;
                }

                // Luteal Bonus (Purple Heart)
                if (logs.some(l => l.date.startsWith(dateStr) && l.type === 'bonus')) {
                    badgesHTML += `<span class="material-symbols-outlined badge badge-luteal">female</span>`;
                }

                // Streak Break (Fire on Red)
                if (statusClass === 'status-missed') {
                    badgesHTML += `<span class="material-symbols-outlined badge badge-break">local_fire_department</span>`;
                }

                badgesHTML += `</div>`;
                cell.innerHTML += badgesHTML;

                // Apply Border
                if(statusClass) cell.classList.add(statusClass);

                grid.appendChild(cell);
            }
        }
    </script>
</body>
</html>