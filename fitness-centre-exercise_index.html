<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Centre | Exercise Index</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@300;400;500;700&family=Oswald:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,300,0,0" />
    
    <script src="js/core.js"></script> 

    <style>
        /* --- SYSTEM VARIABLES (TACTICAL HUD) --- */
        :root {
            --font-header: 'Oswald', sans-serif;
            --font-body: 'Red Hat Display', sans-serif;
            
            --color-accent: #00e5ff; /* Cyan */
            --color-accent-dim: rgba(0, 229, 255, 0.15);
            --color-gold: #FFD700;   /* PBs */
            
            --color-white: #ffffff;
            --color-white-muted: rgba(255, 255, 255, 0.6);
            --color-red: #ff3d3d;
            
            --glass-bg: rgba(20, 20, 20, 0.6);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            
            --bg-image: url('https://i.imgur.com/pqsR1wV.jpeg');
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            height: 100vh; width: 100vw;
            background-image: var(--bg-image); 
            background-size: cover; background-position: center;
            font-family: var(--font-body); 
            color: var(--color-white); 
            overflow: hidden; 
            background-color: #050505;
        }

        /* Vignette Overlay */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, rgba(10,12,14,0.7) 0%, rgba(0,0,0,0.95) 100%);
            z-index: 0; pointer-events: none;
        }

        .container {
            position: relative; z-index: 1; height: 100%; padding: 30px 50px;
            padding-top: 80px; /* Breathing room */
            display: flex; flex-direction: column;
        }

        /* --- HEADER --- */
        .top-bar { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 30px; border-bottom: var(--glass-border); padding-bottom: 20px;}
        
        .back-btn {
            position: absolute; top: 30px; left: 50px; 
            color: var(--color-white-muted); text-decoration: none; 
            font-size: 10px; letter-spacing: 2px; text-transform: uppercase;
            display: flex; align-items: center; gap: 10px; transition: 0.3s; z-index: 10;
        }
        .back-btn:hover { color: var(--color-accent); gap: 15px; }

        .brand-area { display: flex; flex-direction: column; }
        
        /* GLOWING TITLE */
        .page-title { 
            font-family: var(--font-header); font-size: 60px; 
            text-transform: uppercase; letter-spacing: 8px; line-height: 0.8;
            color: transparent; 
            -webkit-text-stroke: 2px rgba(255,255,255,0.9); 
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.4); 
        }

        .controls-area { display: flex; align-items: center; gap: 20px; position: relative; }
        
        .control-icon { 
            font-size: 24px !important; cursor: pointer; color: var(--color-white-muted); transition: 0.3s; 
            border: 1px solid transparent; padding: 8px; border-radius: 50%;
        }
        .control-icon:hover { color: var(--color-accent); border-color: var(--color-accent); background: var(--color-accent-dim); }
        
        /* ACTIVE FILTER GLOW */
        .control-icon.active-filter {
            color: var(--color-accent);
            text-shadow: 0 0 15px var(--color-accent);
            border-color: var(--color-accent);
        }

        .add-btn { 
            font-size: 32px !important; cursor: pointer; transition: 0.3s; 
            color: var(--color-accent); 
        }
        .add-btn:hover { transform: rotate(90deg) scale(1.1); text-shadow: 0 0 15px var(--color-accent); }

        /* Search Bar Integrated into Controls */
        .search-wrapper { position: relative; margin-right: 10px; }
        .search-input {
            background: rgba(0,0,0,0.5); border: var(--glass-border); padding: 10px 15px;
            color: var(--color-white); font-family: var(--font-body); width: 250px; font-size: 12px;
            border-radius: 20px; transition: 0.3s; letter-spacing: 1px;
        }
        .search-input:focus { border-color: var(--color-accent); outline: none; width: 280px; box-shadow: 0 0 15px var(--color-accent-dim); }

        /* SORT MENU */
        .sort-menu {
            display: none; position: absolute; top: 50px; right: 60px;
            background: #0a0a0a; border: 1px solid var(--color-accent); 
            box-shadow: 0 0 30px rgba(0,0,0,0.8); z-index: 20; width: 150px;
        }
        .sort-option {
            padding: 12px 20px; font-size: 12px; cursor: pointer; color: var(--color-white-muted); 
            display: flex; align-items: center; gap:8px; transition: 0.2s; text-transform: uppercase; letter-spacing: 1px;
        }
        .sort-option:hover { background: var(--color-accent-dim); color: var(--color-white); }
        .sort-option.active { color: var(--color-accent); font-weight: bold; border-left: 2px solid var(--color-accent); }

        /* --- GRID LIST --- */
        .list-container { height: 100%; overflow-y: auto; padding-right: 10px; }
        .list-container::-webkit-scrollbar { width: 4px; }
        .list-container::-webkit-scrollbar-thumb { background: var(--color-accent); }

        /* Header Row */
        .list-header-row {
            display: grid;
            grid-template-columns: 250px 2px 80px 1fr 1fr 1fr 1fr 80px; 
            padding: 10px 20px; font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: var(--color-accent); font-weight: 700;
            border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px;
        }

        .list-row {
            display: grid;
            grid-template-columns: 250px 2px 80px 1fr 1fr 1fr 1fr 80px; 
            align-items: center; padding: 15px 20px; font-size: 13px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            transition: 0.2s; cursor: default;
        }
        .list-row:hover { background: rgba(255,255,255,0.05); border-left: 2px solid var(--color-accent); }

        .col-name { 
            font-family: var(--font-header); font-size: 16px; letter-spacing: 1px; 
            cursor: pointer; transition: color 0.2s; color: var(--color-white); text-transform: uppercase;
        }
        .col-name:hover { color: var(--color-accent); text-shadow: 0 0 10px var(--color-accent-dim); }
        
        .col-separator { height: 20px; background-color: rgba(255,255,255,0.1); }
        
        .col-freq { text-align: center; color: var(--color-white-muted); font-family: 'Courier New', monospace; font-size: 12px; }
        .col-data { color: var(--color-white-muted); font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 10px; text-transform: uppercase; letter-spacing: 1px; }
        
        .col-actions { display: flex; gap: 15px; opacity: 0.3; justify-content: flex-end; }
        .list-row:hover .col-actions { opacity: 1; }
        
        .action-tiny { font-size: 18px !important; cursor: pointer; transition: 0.2s; }
        .action-tiny:hover { color: var(--color-accent); transform: scale(1.1); }
        .action-tiny.del:hover { color: var(--color-red); }
        .action-locked { font-size: 18px !important; color: var(--color-accent); opacity: 0.5; cursor: default; }

        /* --- MODALS (COMMAND TERMINAL STYLE) --- */
        .modal-backdrop {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 100;
            justify-content: center; align-items: center; backdrop-filter: blur(8px);
        }

        .input-modal {
            background: #0a0a0a; width: 500px; padding: 40px;
            border: 1px solid var(--color-accent); box-shadow: 0 0 50px rgba(0, 229, 255, 0.1); 
            position: relative; overflow: visible; 
        }
        
        /* Modal Corner Accents */
        .input-modal::after {
            content: ''; position: absolute; bottom: 0; right: 0; width: 15px; height: 15px;
            border-bottom: 2px solid var(--color-accent); border-right: 2px solid var(--color-accent);
        }

        .input-group { margin-bottom: 20px; position: relative; }
        .input-label { 
            display: block; font-size: 10px; color: var(--color-accent); 
            margin-bottom: 8px; text-transform: uppercase; letter-spacing: 2px; font-weight: 700; 
        }
        
        .text-input, .select-input {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            padding: 12px; color: white; font-family: var(--font-body); font-size: 14px;
            transition: 0.3s;
        }
        .text-input:focus, .select-input:focus { border-color: var(--color-accent); outline: none; background: var(--color-accent-dim); }

        /* TAGS INPUT */
        .multi-select-container {
            background: rgba(255,255,255,0.02); padding: 8px; min-height: 45px;
            display: flex; flex-wrap: wrap; gap: 8px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1);
            transition: 0.3s;
        }
        .multi-select-container:hover { border-color: var(--color-white-muted); }
        
        .selected-tag {
            background: var(--color-accent-dim); padding: 4px 10px; font-size: 10px;
            display: flex; align-items: center; gap: 8px; border: 1px solid var(--color-accent);
            color: var(--color-white); text-transform: uppercase; letter-spacing: 1px;
        }
        .remove-tag { cursor: pointer; font-weight: bold; color: var(--color-accent); font-size: 14px; }
        .remove-tag:hover { color: #fff; }
        
        .dropdown-list {
            position: absolute; top: 100%; left: 0; width: 100%;
            background: #111; border: 1px solid var(--color-accent); 
            max-height: 200px; overflow-y: auto; display: none; z-index: 1000;
        }
        .dropdown-item { padding: 12px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #222; color: #ccc; text-transform: uppercase;}
        .dropdown-item:hover { background: var(--color-accent); color: #000; }

        .modal-actions { display: flex; justify-content: flex-end; gap: 20px; margin-top: 30px; }
        .btn-text { background: none; border: none; font-family: var(--font-body); cursor: pointer; font-size: 12px; letter-spacing: 2px; text-transform: uppercase; font-weight: 700; }
        .btn-cancel { color: var(--color-white-muted); border: 1px solid transparent; padding: 10px 20px;}
        .btn-cancel:hover { color: var(--color-red); border-color: var(--color-red); }
        .btn-confirm { background: var(--color-accent); color: #000; padding: 10px 30px; box-shadow: 0 0 15px var(--color-accent-dim); }
        .btn-confirm:hover { background: #fff; }

        /* --- HISTORY MODAL (DARK PRESTIGE) --- */
        .history-modal {
            background: #050505; width: 600px; padding: 40px;
            border: 1px solid var(--color-accent); box-shadow: 0 0 60px rgba(0, 229, 255, 0.15);
            position: relative;
        }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px;}
        .history-title { font-family: var(--font-header); font-size: 32px; text-transform: uppercase; letter-spacing: 2px; color: white; }
        .history-count { color: var(--color-accent); font-size: 12px; font-family: var(--font-body); letter-spacing: 1px; text-transform: uppercase; }

        .log-scroll-area { max-height: 450px; overflow-y: auto; padding-right: 10px; display: flex; flex-direction: column; gap: 15px; }
        .log-scroll-area::-webkit-scrollbar { width: 4px; }
        .log-scroll-area::-webkit-scrollbar-thumb { background: var(--color-accent); }

        .history-entry {
            display: flex; flex-direction: column; 
            padding: 20px;
            background: rgba(255,255,255,0.03); 
            border-left: 2px solid var(--color-accent);
            transition: transform 0.2s ease;
        }
        .history-entry:hover { background: rgba(255,255,255,0.06); transform: translateX(5px); }

        .history-header-row {
            display: flex; justify-content: space-between; width: 100%;
            align-items: center; margin-bottom: 10px;
        }

        .history-date {
            font-size: 12px; color: var(--color-white-muted); 
            text-transform: uppercase; letter-spacing: 2px; font-weight: 700;
        }

        .pb-crown {
            color: var(--color-gold); font-size: 18px; 
            filter: drop-shadow(0 0 10px rgba(255, 215, 0, 0.6));
        }

        .history-sets-list {
            width: 100%; display: flex; flex-direction: column;
            gap: 5px; padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .history-set-row {
            display: flex; justify-content: space-between;
            font-size: 13px; color: #ccc;
        }
        .history-set-row span.faded { color: #666; font-size: 10px; text-transform: uppercase; letter-spacing: 1px; }

        /* --- FILTER MODAL (CENTERED & STABLE) --- */
        .modal-backdrop#filterModal {
            background: rgba(0, 0, 0, 0.6); /* Slight dim so you can focus */
            backdrop-filter: blur(2px);
            align-items: center; /* Center Vertically */
            justify-content: center; /* Center Horizontally */
            pointer-events: auto; /* Enable clicking background to close */
            display: none; /* Hidden by default */
        }
        
        /* Specific override to make sure flex works when active */
        .modal-backdrop#filterModal.active {
            display: flex;
        }

        .filter-modal {
            background: #0a0a0a; 
            width: 500px; /* Wider for better layout */
            padding: 30px;
            margin: 0; /* Remove the floating margins */
            border: 1px solid var(--color-accent); 
            box-shadow: 0 0 60px rgba(0,0,0,0.9);
            max-height: 85vh; /* Ensure it never goes off screen vertically */
            overflow-y: auto; /* ENABLE SCROLLING inside the box */
            position: relative;
        }
        
        /* Custom Scrollbar for the modal */
        .filter-modal::-webkit-scrollbar { width: 4px; }
        .filter-modal::-webkit-scrollbar-thumb { background: var(--color-accent); border-radius: 4px; }
        
        .tag-cloud { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 15px; }
        
        .tag {
            background: rgba(255,255,255,0.05); padding: 8px 12px; font-size: 11px; cursor: pointer;
            border: 1px solid rgba(255,255,255,0.1); text-transform: uppercase; letter-spacing: 1px; color: #aaa;
            transition: 0.2s; flex: 0 0 auto; /* Prevent squishing */
        }
        .tag:hover { border-color: var(--color-white); color: #fff; }
        .tag.active { border-color: var(--color-accent); color: #000; background: var(--color-accent); font-weight: 700; }
        
        .apply-btn {
            width: 100%; padding: 15px; background: var(--color-accent); border: none; color: #000;
            font-weight: 700; cursor: pointer; margin-top: 20px; text-transform: uppercase; letter-spacing: 2px;
            transition: 0.3s; font-size: 12px; position: sticky; bottom: 0;
        }
        .apply-btn:hover { background: #fff; box-shadow: 0 0 20px var(--color-accent-dim); }

        .btn-clear {
            width: 100%; margin-top: 10px; background: transparent; border: 1px solid #333; color: #666;
            padding: 10px; cursor: pointer; font-size: 10px; text-transform: uppercase; letter-spacing: 2px; transition: 0.3s;
        }
        .btn-clear:hover { border-color: var(--color-red); color: var(--color-red); }

        /* CONFIRM BOX */
        .confirm-box {
            background: #000; color: white; padding: 40px; text-align: center;
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 450px; z-index: 200; display: none; box-shadow: 0 0 50px rgba(255, 61, 61, 0.2);
            border: 1px solid var(--color-red);
        }
        .confirm-title { font-family: var(--font-header); font-size: 24px; margin-bottom: 30px; display: block; letter-spacing: 2px; color: var(--color-red); }
        .confirm-actions { display: flex; justify-content: center; gap: 20px; }
        .btn-pill {
            padding: 12px 40px; border: 1px solid transparent; cursor: pointer; font-weight: bold; font-size: 12px; text-transform: uppercase; letter-spacing: 2px; transition: 0.3s;
        }
        .btn-yup { background: var(--color-red); color: white; }
        .btn-yup:hover { box-shadow: 0 0 20px rgba(255, 61, 61, 0.4); }
        .btn-nope { background: transparent; border: 1px solid #555; color: white; }
        .btn-nope:hover { border-color: #fff; }

    </style>
</head>
<body>

    <div class="overlay"></div>

    <div class="container">
        <a href="fitness-centre-training_deck.html" class="back-btn" title="Back to Deck">
            <span class="material-symbols-outlined" style="font-size: 14px;">arrow_back</span> DECK
        </a>

        <div class="top-bar">
            <div class="brand-area">
                <h1 class="page-title">Exercise Index</h1>
            </div>

            <div class="controls-area">
                <div class="search-wrapper">
                    <input type="text" class="search-input" placeholder="SEARCH DATABASE..." onkeyup="renderGrid()">
                </div>
                <span class="material-symbols-outlined control-icon" id="btnFilterIcon" onclick="toggleFilterModal()" title="Filter">filter_alt</span>
                <span class="material-symbols-outlined control-icon" onclick="toggleSort()" title="Sort">sort</span>
                
                <div class="sort-menu" id="sortMenu">
                    <div class="sort-option active" onclick="applySort('name')">Name (A-Z)</div>
                    <div class="sort-option" onclick="applySort('freq')">Usage Freq.</div>
                </div>
                
                <span class="material-symbols-outlined add-btn" onclick="openAddModal()" title="Add New">add_circle</span>
            </div>
        </div>

        <div class="list-header-row">
            <div>Name</div>
            <div></div>
            <div style="text-align:center">Count</div>
            <div>Target</div>
            <div>Equip</div>
            <div>Position</div>
            <div>Type</div>
            <div style="text-align:right">Edit</div>
        </div>

        <div class="list-container" id="gridContainer"></div>
    </div>

    <div class="modal-backdrop" id="addModal">
        <div class="input-modal">
            <span style="position:absolute; top:20px; right:20px; cursor:pointer; font-size:18px; color:#666; transition:0.3s" onclick="closeAddModal()" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#666'">✕</span>
            <h2 id="modalTitle" style="font-family:var(--font-header); font-weight:400; margin-bottom:30px; letter-spacing: 3px; color:var(--color-white); font-size:28px;">NEW ENTRY</h2>
            
            <div class="input-group"><label class="input-label">Exercise Name</label><input type="text" id="inpName" class="text-input" placeholder="DESIGNATION..."></div>
            
            <div class="input-group">
                <label class="input-label">Muscle Target</label>
                <div class="multi-select-container" onclick="toggleDropdown('ddTarget')"><div id="tagsTarget" style="display:flex; gap:5px; flex-wrap:wrap;"></div></div>
                <div class="dropdown-list" id="ddTarget"></div>
            </div>
            
            <div class="input-group"><label class="input-label">Equipment</label><select id="inpEquip" class="select-input"></select></div>
            
            <div class="input-group">
                <label class="input-label">Positioning</label>
                <div class="multi-select-container" onclick="toggleDropdown('ddPos')"><div id="tagsPos" style="display:flex; gap:5px; flex-wrap:wrap;"></div></div>
                <div class="dropdown-list" id="ddPos"></div>
            </div>
            
            <div class="input-group"><label class="input-label">Tracking Type</label><select id="inpType" class="select-input"></select></div>
            
            <div class="modal-actions">
                <button class="btn-text btn-cancel" onclick="closeAddModal()">CANCEL</button>
                <button class="btn-text btn-confirm" onclick="saveExercise()">SAVE EXERCISE</button>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="historyModal">
        <div class="history-modal">
            <span style="position:absolute; top:20px; right:20px; cursor:pointer; font-size:18px; color:#666; transition:0.3s;" onclick="closeHistory()" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='#666'">✕</span>
            <div class="history-header">
                <h2 class="history-title" id="histTitle">EXERCISE NAME</h2>
                <span class="history-count" id="histCount">LOGGED: 0</span>
            </div>
            <div class="log-scroll-area" id="historyContainer"></div>
            
            <div class="modal-actions-row" style="margin-top:30px; display:flex; justify-content:space-between; padding-top:20px; border-top:1px solid rgba(255,255,255,0.1);">
                <button class="btn-text btn-confirm" style="background:transparent; color:var(--color-accent); border:1px solid var(--color-accent); padding:10px 20px; box-shadow:none;" onclick="confirmAction('permanent')">LOCK AS PERMANENT</button>
                <button class="btn-text btn-confirm" style="background:#333; color:#fff; box-shadow:none;" onclick="closeHistory()">CLOSE LOG</button>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="filterModal">
        <div class="filter-modal">
            <span style="position:absolute; top:20px; right:20px; cursor:pointer; color:#666;" onclick="toggleFilterModal()">✕</span>
            <h2 style="margin-bottom:20px; font-family:var(--font-header); letter-spacing:3px; color:var(--color-white); font-size:18px;">Select to Filter</h2>
            
            <div class="input-group"><label class="input-label">Muscle Target</label><div class="tag-cloud" id="filterTarget"></div></div>
            <div class="input-group"><label class="input-label">Equipment</label><div class="tag-cloud" id="filterEquip"></div></div>
            <div class="input-group"><label class="input-label">Positioning</label><div class="tag-cloud" id="filterPos"></div></div>
            <div class="input-group"><label class="input-label">Type</label><div class="tag-cloud" id="filterType"></div></div>
            
            <button class="apply-btn" onclick="applyFilter()">APPLY FILTERS</button>
            <button class="btn-clear" onclick="clearFilters()">CLEAR ALL</button>
        </div>
    </div>

    <div class="confirm-box" id="confirmBox">
        <span class="confirm-title" id="confirmText">CONFIRM DELETION</span>
        <div class="confirm-actions">
            <button class="btn-pill btn-yup" id="btnConfirmYes">CONFIRM</button>
            <button class="btn-pill btn-nope" onclick="closeConfirm()">CANCEL</button>
        </div>
    </div>

    <script>
        const LIST_TARGETS = ["Abs", "Back", "Biceps", "Calf", "Cardio", "Chest", "Forearms", "Full Body", "Glutes", "Hamstrings", "Hip Flexors", "Obliques", "Quads", "Shoulders", "Triceps"].sort();
        const LIST_EQUIP = ["Band", "Barbell", "Bodyweight", "Cable", "Dumbbell", "EZ Bar", "Kettle Ball", "Machine/Other", "Plates", "Ropes"].sort();
        const LIST_POS = ["Assisted", "Back", "Bent Down", "Bilateral", "Decline", "Flat", "Front", "Half Kneeling", "Hanging", "Incline", "Jump", "Kneeling", "Lateral", "Lying", "Overhead", "Plank", "Seated", "Squat", "Standing", "Twist", "Upright"].sort();
        const LIST_TYPES = ["Weight & Reps", "Reps", "Time", "Distance", "Distance & Time"];

        let exercises = JSON.parse(localStorage.getItem('lh_exercises')) || [];
        let editId = null;
        let currentOpenId = null;
        let activeFilters = [];
        let currentSort = 'name';

        window.onload = function() { populateDropdowns(); applySort('name'); };

        function getUsageCount(exId) {
            const currentTemplates = JSON.parse(localStorage.getItem('lh_templates')) || [];
            // Check both dbId (new structure) and id (old legacy structure if any)
            return currentTemplates.filter(t => t.exercises && t.exercises.some(e => e.dbId === exId || e.id === exId)).length;
        }

        function populateDropdowns() {
            const fillDrop = (id, list, onClickFunc) => { document.getElementById(id).innerHTML = list.map(item => `<div class="dropdown-item" onclick="${onClickFunc}('${item}')">${item}</div>`).join(''); };
            fillDrop('ddTarget', LIST_TARGETS, 'addTagTarget'); fillDrop('ddPos', LIST_POS, 'addTagPos');
            document.getElementById('inpEquip').innerHTML = LIST_EQUIP.map(i => `<option style="color:#000">${i}</option>`).join('');
            document.getElementById('inpType').innerHTML = LIST_TYPES.map(i => `<option style="color:#000">${i}</option>`).join('');
            const fillCloud = (id, list) => { document.getElementById(id).innerHTML = list.map(t => `<div class="tag" onclick="toggleFilterTag(this, '${t}')">${t}</div>`).join(''); };
            fillCloud('filterTarget', LIST_TARGETS); fillCloud('filterEquip', LIST_EQUIP); fillCloud('filterPos', LIST_POS); fillCloud('filterType', LIST_TYPES);
        }

        function renderGrid() {
    const container = document.getElementById('gridContainer');
    const searchVal = document.querySelector('.search-input').value.toLowerCase();
    container.innerHTML = '';

    exercises.forEach(ex => {
        // 1. Text Search Check
        if (!ex.name.toLowerCase().includes(searchVal)) return;

        // 2. Strict Filter Check (The Fix)
        if (activeFilters.length > 0) {
            // Gather all tags this exercise has
            const allTags = [...ex.target, ex.equip, ...ex.pos, ex.type];
            
            // OLD LOGIC: activeFilters.some(...) -> Show if ANY match
            // NEW LOGIC: activeFilters.every(...) -> Show only if ALL match
            const matchesAll = activeFilters.every(filter => allTags.includes(filter));
            
            // If it fails even one requirement, hide it.
            if (!matchesAll) return;
        }

        const realFreq = getUsageCount(ex.id);
        const displayFreq = realFreq < 10 ? '0' + realFreq : realFreq;

        let actionHTML = ex.isPermanent ? `<span class="material-symbols-outlined action-locked">lock</span>` : `<span class="material-symbols-outlined action-tiny" onclick="openEdit(${ex.id})">edit_square</span><span class="material-symbols-outlined action-tiny del" onclick="confirmAction('delete', ${ex.id})">delete</span>`;

        const row = document.createElement('div');
        row.className = 'list-row';
        row.innerHTML = `<div class="col-name" onclick="openHistory(${ex.id})">${ex.name}</div><div class="col-separator"></div><div class="col-freq">${displayFreq}</div><div class="col-data">${ex.target.join(', ')}</div><div class="col-data">${ex.equip}</div><div class="col-data">${ex.pos.join(', ')}</div><div class="col-data">${ex.type}</div><div class="col-actions">${actionHTML}</div>`;
        container.appendChild(row);
    });
}

        // --- SORT & FILTER UTILS ---
        function toggleSort() { document.getElementById('sortMenu').style.display = (document.getElementById('sortMenu').style.display === 'block') ? 'none' : 'block'; document.getElementById('filterModal').classList.remove('active'); }
        function applySort(type) {
            currentSort = type;
            document.querySelectorAll('.sort-option').forEach(el => el.classList.remove('active'));
            if(type === 'name') { exercises.sort((a, b) => a.name.localeCompare(b.name)); document.querySelectorAll('.sort-option')[0].classList.add('active'); } 
            else { exercises.sort((a, b) => getUsageCount(b.id) - getUsageCount(a.id)); document.querySelectorAll('.sort-option')[1].classList.add('active'); }
            document.getElementById('sortMenu').style.display = 'none'; renderGrid();
        }
        
        // --- NEW FLOATING FILTER LOGIC ---
        function toggleFilterModal() { 
    const modal = document.getElementById('filterModal');
    
    // Check if it is currently visible
    if(modal.style.display === 'flex') {
        // If open, close it
        modal.style.display = 'none';
        modal.classList.remove('active');
    } else {
        // If closed, open it using FLEX (this centers it)
        modal.style.display = 'flex'; 
        modal.classList.add('active');
    }
    
    // Always hide the sort menu if we open the filter
    document.getElementById('sortMenu').style.display = 'none'; 
}
        
        function toggleFilterTag(el, tag) { el.classList.toggle('active'); if (activeFilters.includes(tag)) activeFilters = activeFilters.filter(t => t !== tag); else activeFilters.push(tag); }
        
        function applyFilter() { 
            renderGrid(); 
            toggleFilterModal(); 
            // GLOW INDICATOR
            const icon = document.getElementById('btnFilterIcon');
            if(activeFilters.length > 0) icon.classList.add('active-filter');
            else icon.classList.remove('active-filter');
        }

        function clearFilters() {
            activeFilters = [];
            document.querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
            applyFilter();
        }

        // --- CRUD ACTIONS ---
        function openAddModal() { editId = null; document.getElementById('modalTitle').innerText = "NEW EXERCISE"; document.getElementById('inpName').value = ''; document.getElementById('tagsTarget').innerHTML = ''; document.getElementById('tagsPos').innerHTML = ''; document.getElementById('addModal').style.display = 'flex'; }
        function openEdit(id) { editId = id; const ex = exercises.find(e => e.id === id); document.getElementById('modalTitle').innerText = "EDIT ENTRY"; document.getElementById('inpName').value = ex.name; document.getElementById('inpEquip').value = ex.equip; document.getElementById('inpType').value = ex.type; const targetCont = document.getElementById('tagsTarget'); targetCont.innerHTML = ''; ex.target.forEach(t => createTagHTML(targetCont, t)); const posCont = document.getElementById('tagsPos'); posCont.innerHTML = ''; ex.pos.forEach(p => createTagHTML(posCont, p)); document.getElementById('addModal').style.display = 'flex'; }
        function saveExercise() {
            const name = document.getElementById('inpName').value; const equip = document.getElementById('inpEquip').value; const type = document.getElementById('inpType').value;
            const targets = [...document.getElementById('tagsTarget').children].map(c => c.innerText.replace('×','').trim());
            const pos = [...document.getElementById('tagsPos').children].map(c => c.innerText.replace('×','').trim());
            if(!name) return alert("Designation required.");
            if (editId) { const index = exercises.findIndex(e => e.id === editId); exercises[index].name = name; exercises[index].equip = equip; exercises[index].type = type; exercises[index].target = targets; exercises[index].pos = pos; } 
            else { const newEx = { id: Date.now(), name: name, target: targets.length?targets:["-"], equip: equip, pos: pos.length?pos:["-"], type: type, isPermanent: false }; exercises.push(newEx); }
            localStorage.setItem('lh_exercises', JSON.stringify(exercises)); applySort(currentSort); closeAddModal();
        }
        function closeAddModal() { document.getElementById('addModal').style.display = 'none'; }
        function toggleDropdown(id) { const el = document.getElementById(id); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
        function addTagTarget(txt) { createTagHTML(document.getElementById('tagsTarget'), txt); document.getElementById('ddTarget').style.display='none'; }
        function addTagPos(txt) { createTagHTML(document.getElementById('tagsPos'), txt); document.getElementById('ddPos').style.display='none'; }
        function createTagHTML(container, text) { if([...container.children].some(c => c.textContent.includes(text))) return; container.innerHTML += `<span class="selected-tag">${text} <span class="remove-tag" onclick="this.parentElement.remove()">×</span></span>`; }
        function confirmAction(action, id) { const box = document.getElementById('confirmBox'); box.style.display = 'block'; if (action === 'delete') { document.getElementById('confirmText').innerText = "DELETE ENTRY?"; document.getElementById('btnConfirmYes').onclick = function() { exercises = exercises.filter(e => e.id !== id); localStorage.setItem('lh_exercises', JSON.stringify(exercises)); renderGrid(); closeConfirm(); } } else if (action === 'permanent') { document.getElementById('confirmText').innerText = "LOCK ENTRY?"; document.getElementById('btnConfirmYes').onclick = function() { const index = exercises.findIndex(e => e.id === currentOpenId); if(index !== -1) { exercises[index].isPermanent = true; localStorage.setItem('lh_exercises', JSON.stringify(exercises)); renderGrid(); closeConfirm(); closeHistory(); } } } }
        function closeConfirm() { document.getElementById('confirmBox').style.display = 'none'; }

        // --- HISTORY LOGIC ---
        function openHistory(id) {
    currentOpenId = id;
    const ex = exercises.find(e => e.id === id);
    document.getElementById('histTitle').innerText = ex.name;
    
    const templates = JSON.parse(localStorage.getItem('lh_templates')) || [];
    // We filter for ANY template that used this exercise ID
    const logs = templates.filter(t => t.exercises && t.exercises.some(e => e.dbId === id));
    
    // Sort by date (Newest first)
    logs.sort((a, b) => new Date(b.date) - new Date(a.date));

    document.getElementById('histCount').innerText = `LOGGED: ${logs.length}`;
    const container = document.getElementById('historyContainer');
    container.innerHTML = '';

    if(logs.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#444; padding:20px; font-style:italic;">NO COMBAT DATA FOUND.</div>';
    } else {
        // 1. Calculate Global Personal Best (PB) for the Crown Icon
        let globalMax = 0;
        logs.forEach(log => {
            const specificEx = log.exercises.find(e => e.dbId === id);
            if(specificEx && specificEx.sets) {
                specificEx.sets.forEach(s => {
                    const weight = parseFloat(s[0]) || 0;
                    if(weight > globalMax) globalMax = weight;
                });
            }
        });

        // 2. Render Each Log
        logs.forEach(log => {
            const specificEx = log.exercises.find(e => e.dbId === id);
            const dateStr = log.date ? new Date(log.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }).toUpperCase() : 'UNKNOWN DATE';
            
            // Calculate Session Max
            let sessionMax = 0;
            if(specificEx.sets) {
                specificEx.sets.forEach(s => {
                    const w = parseFloat(s[0]) || 0;
                    if(w > sessionMax) sessionMax = w;
                });
            }
            const isPB = (sessionMax >= globalMax) && (globalMax > 0);
            const crownIcon = isPB ? '<span class="pb-crown" title="PERSONAL BEST">♛</span>' : '';

            // Build Sets HTML
            let setsHtml = '<div class="history-sets-list">';
            if(specificEx.sets) {
                specificEx.sets.forEach((set, index) => {
                    const w = set[0] || "-";
                    const r = set[1] || "-";
                    setsHtml += `
                        <div class="history-set-row">
                            <span class="faded">SET ${index + 1}</span>
                            <span><strong style="color:#fff">${w}</strong> KG &nbsp;x&nbsp; ${r} REPS</span>
                        </div>`;
                });
            }
            setsHtml += '</div>';

            // --- NEW: Render Note if it exists ---
            let noteHtml = '';
            if (specificEx.note && specificEx.note.trim() !== "") {
                // Adds a subtle divider and prints the note in accent color
                noteHtml = `<div style="margin-top:10px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.1); color:var(--color-accent); font-size:11px; font-style:italic; line-height:1.4; opacity:0.8;">NOTE: "${specificEx.note}"</div>`;
            }

            const html = `
                <div class="history-entry">
                    <div class="history-header-row">
                        <div class="history-date">${dateStr}</div>
                        <div>${crownIcon}</div>
                    </div>
                    ${setsHtml}
                    ${noteHtml}
                </div>
            `;
            container.innerHTML += html;
        });
    }
    
    // Lock Button Logic
    const lockBtnHTML = ex.isPermanent 
    ? `<button class="btn-text" style="color:#444; cursor:default; border:1px solid #333; padding:10px 20px; font-size:10px;"> <span class="material-symbols-outlined" style="font-size:12px; vertical-align:middle;">lock</span> PERMANENT</button>` 
    : `<button class="btn-text btn-confirm" style="background:transparent; color:var(--color-accent); border:1px solid var(--color-accent); padding:10px 20px; box-shadow:none;" onclick="confirmAction('permanent')">LOCK AS PERMANENT</button>`;

    document.querySelector('.modal-actions-row').innerHTML = `
        ${lockBtnHTML}
        <button class="btn-text btn-confirm" style="background:#333; color:#fff; box-shadow:none;" onclick="closeHistory()">CLOSE LOG</button>
    `;

    document.getElementById('historyModal').style.display = 'flex';
}

        function closeHistory() { document.getElementById('historyModal').style.display = 'none'; currentOpenId = null; }

    </script>
</body>
</html>